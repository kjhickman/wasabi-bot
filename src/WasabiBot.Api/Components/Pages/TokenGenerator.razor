@using Microsoft.AspNetCore.Components.Forms

<section aria-labelledby="token-heading">
    <hgroup>
        <h2 id="token-heading">Hello, <span id="user-greeting">@DisplayName</span></h2>
        <p>Generate a short-lived token to authenticate with the Wasabi Bot API (lasts 1 hour)</p>
    </hgroup>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <article style="background-color: var(--pico-del-color); margin-bottom: 1rem;">
            <p style="margin: 0;">@ErrorMessage</p>
        </article>
    }

    <form method="post" data-enhance @formname="tokenForm">
        <AntiforgeryToken />
        <input type="hidden" name="ShouldGenerateToken" value="true"/>
        <button type="submit" class="primary" style="width:auto; margin-bottom: 1rem;">
            Generate Token
        </button>
    </form>

    @if (!string.IsNullOrEmpty(GeneratedToken))
    {
        <div id="token-panel" data-tooltip="Click to copy" data-placement="bottom" style="border-bottom:none;">
            <p style="margin-bottom:0.25rem;">Your token:</p>
            <pre id="token-output"
                 role="button"
                 tabindex="0"
                 aria-label="Copy token"
                 onclick="window.copyToken()"
                 onkeydown="if(event.key === 'Enter' || event.key === ' ') { event.preventDefault(); window.copyToken(); }"
                 style="white-space:pre-wrap; word-break:break-all; margin:0; padding:0.75rem; border:1px solid currentColor; border-radius:0.5rem; background-color:transparent; cursor:pointer;">@GeneratedToken</pre>
            @if (TokenExpiresAt.HasValue)
            {
                <p style="margin-top:0.5rem;"><small>Expires at: @TokenExpiresAt.Value.ToString("u")</small></p>
            }
        </div>
    }
</section>

<script>
    // Global function for copying token - persists across enhanced navigation
    window.copyToken = async function() {
        const tokenOutput = document.getElementById('token-output');
        if (!tokenOutput) return;
        
        const tokenPanel = document.getElementById('token-panel');
        const text = tokenOutput.textContent?.trim();
        if (!text) return;

        try {
            // Try modern clipboard API first
            if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(text);
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
            
            // Show feedback
            if (tokenPanel) {
                const originalTooltip = tokenPanel.getAttribute('data-tooltip');
                tokenPanel.setAttribute('data-tooltip', 'Copied!');
                setTimeout(() => {
                    tokenPanel.setAttribute('data-tooltip', originalTooltip || 'Click to copy');
                }, 1500);
            }
        } catch (error) {
            console.error('Failed to copy:', error);
            if (tokenPanel) {
                tokenPanel.setAttribute('data-tooltip', 'Failed to copy');
                setTimeout(() => {
                    tokenPanel.setAttribute('data-tooltip', 'Click to copy');
                }, 2000);
            }
        }
    };
</script>
