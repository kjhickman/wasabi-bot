@page "/"
@using Microsoft.AspNetCore.Components.Forms

@if (!IsAuthenticated)
{
    <section id="unauthenticated" aria-labelledby="unauthenticated-heading">
        <article>
            <header>
                <h1 id="unauthenticated-heading">Wasabi Bot</h1>
            </header>
            <p>Connect your Discord account to generate a token for the Wasabi Bot API.</p>
            <footer>
                <a id="login-link" href="/auth/login-discord" role="button" class="secondary">Sign in with Discord</a>
            </footer>
        </article>
    </section>
}
else
{
    <section id="authenticated" aria-labelledby="authenticated-heading">
        <article>
            <header style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
                <h1 id="authenticated-heading" style="margin:0;">Wasabi Bot</h1>
                <form action="/auth/logout" method="post" style="margin:0;">
                    <button id="logout-button" type="submit" class="contrast" style="width:auto; align-self:flex-start;">Log out</button>
                </form>
            </header>

            <section aria-labelledby="token-heading">
                <hgroup>
                    <h2 id="token-heading">Hello, <span id="user-greeting">@DisplayName</span></h2>
                    <p>Generate a short-lived token to authenticate with the Wasabi Bot API (lasts 1 hour)</p>
                </hgroup>

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <article style="background-color: var(--pico-del-color); margin-bottom: 1rem;">
                        <p style="margin: 0;">@ErrorMessage</p>
                    </article>
                }

                <form method="post" data-enhance @formname="tokenForm">
                    <AntiforgeryToken />
                    <input type="hidden" name="ShouldGenerateToken" value="true"/>
                    <button type="submit" class="primary" style="width:auto; margin-bottom: 1rem;">
                        Generate Token
                    </button>
                </form>
                
                <script>
                    console.log('Form script loaded');
                    document.addEventListener('DOMContentLoaded', () => {
                        const form = document.querySelector('form[data-enhance]');
                        if (form) {
                            console.log('Found enhanced form');
                            form.addEventListener('submit', (e) => {
                                console.log('Form submit event fired', e);
                            });
                        } else {
                            console.warn('Enhanced form not found!');
                        }
                    });
                </script>

                @if (!string.IsNullOrEmpty(GeneratedToken))
                {
                    <div id="token-panel" data-tooltip="Click to copy" data-placement="bottom" style="border-bottom:none;">
                        <p style="margin-bottom:0.25rem;">Your token:</p>
                        <pre id="token-output"
                             role="button"
                             tabindex="0"
                             aria-label="Copy token"
                             style="white-space:pre-wrap; word-break:break-all; margin:0; padding:0.75rem; border:1px solid currentColor; border-radius:0.5rem; background-color:transparent; cursor:pointer;">@GeneratedToken</pre>
                        @if (TokenExpiresAt.HasValue)
                        {
                            <p style="margin-top:0.5rem;"><small>Expires at: @TokenExpiresAt.Value.ToString("u")</small></p>
                        }
                    </div>

                    <script>
                        (function() {
                            'use strict';

                            const tokenOutput = document.getElementById('token-output');
                            if (!tokenOutput) return;

                            const tokenPanel = tokenOutput.closest('#token-panel');
                            const defaultTooltip = tokenPanel?.dataset?.tooltip || 'Click to copy';
                            let feedbackTimeoutId;

                            const resetTooltip = () => {
                                clearTimeout(feedbackTimeoutId);
                                if (tokenPanel) {
                                    tokenPanel.setAttribute('data-tooltip', defaultTooltip);
                                }
                            };

                            const showCopiedFeedback = () => {
                                clearTimeout(feedbackTimeoutId);
                                if (tokenPanel) {
                                    tokenPanel.setAttribute('data-tooltip', 'Copied!');
                                }
                                feedbackTimeoutId = setTimeout(resetTooltip, 1500);
                            };

                            const copyToClipboard = async (text) => {
                                try {
                                    if (navigator.clipboard?.writeText) {
                                        await navigator.clipboard.writeText(text);
                                        return true;
                                    }

                                    const textArea = document.createElement('textarea');
                                    textArea.value = text;
                                    textArea.style.position = 'fixed';
                                    textArea.style.left = '-9999px';
                                    document.body.appendChild(textArea);
                                    textArea.focus();
                                    textArea.select();

                                    try {
                                        return document.execCommand('copy');
                                    } finally {
                                        document.body.removeChild(textArea);
                                    }
                                } catch (error) {
                                    return false;
                                }
                            };

                            const handleCopy = async () => {
                                const text = tokenOutput.textContent?.trim();
                                if (!text) return;

                                const success = await copyToClipboard(text);
                                if (success) {
                                    showCopiedFeedback();
                                } else {
                                    if (tokenPanel) {
                                        tokenPanel.setAttribute('data-tooltip', 'Failed to copy. Please copy manually.');
                                        setTimeout(resetTooltip, 2000);
                                    }
                                }
                            };

                            tokenOutput.addEventListener('click', handleCopy);
                            tokenOutput.addEventListener('keydown', (event) => {
                                if (event.key === 'Enter' || event.key === ' ') {
                                    event.preventDefault();
                                    handleCopy();
                                }
                            });
                        })();
                    </script>
                }
            </section>
        </article>
    </section>
}

